{% extends "layout.html" %}

{% block title %}New Inspection{% endblock %}

{% block main %}
<h2>New Inspection - {{ form.name }}</h2>
<p>{{ form.description }}</p>

<!-- Flash message block -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post">
    {% for field in fields %}
        <div style="margin-bottom: 20px;">
            <label><strong>{{ field.label }}</strong>{% if field.required %} *{% endif %}</label><br>

            {% set val = submitted_data.get('field_' ~ field.id|string) if submitted_data else '' %}

            {% if field.field_type == 'text' %}
                <input type="text" name="field_{{ field.id }}" class="form-control"
                       value="{{ val }}" {% if field.required %}required{% endif %}>

            {% elif field.field_type == 'textarea' %}
                <textarea name="field_{{ field.id }}" class="form-control" rows="3"
                          {% if field.required %}required{% endif %}>{{ val }}</textarea>

            {% elif field.field_type == 'select' and field.options %}
                <select name="field_{{ field.id }}" class="form-control" {% if field.required %}required{% endif %}>
                    <option value="">-- Select --</option>
                    {% for option in field.options.split(',') %}
                        <option value="{{ option|trim }}" {% if val == option|trim %}selected{% endif %}>{{ option|trim }}</option>
                    {% endfor %}
                </select>

            {% elif field.field_type == 'date' %}
                <input type="date" name="field_{{ field.id }}" class="form-control"
                       value="{{ val }}" {% if field.required %}required{% endif %}>

            {% elif field.field_type == 'number' %}
                <input type="number" name="field_{{ field.id }}" class="form-control"
                       value="{{ val }}" {% if field.required %}required{% endif %}>

            {% elif field.field_type == 'radio' and field.options %}
                {% for option in field.options.split(',') %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                               name="field_{{ field.id }}"
                               id="field_{{ field.id }}_{{ loop.index0 }}"
                               value="{{ option|trim }}"
                               {% if val == option|trim %}checked{% endif %}
                               {% if field.required %}required{% endif %}>
                        <label class="form-check-label" for="field_{{ field.id }}_{{ loop.index0 }}">{{ option|trim }}</label>
                    </div>
                {% endfor %}

            {% elif field.field_type == 'checkbox' and field.options %}
                {% set selected_values = submitted_data.getlist('field_' ~ field.id ~ '[]') if submitted_data else [] %}
                {% for option in field.options.split(',') %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="field_{{ field.id }}[]"
                               id="field_{{ field.id }}_{{ loop.index0 }}"
                               value="{{ option|trim }}"
                               {% if option|trim in selected_values %}checked{% endif %}>
                        <label class="form-check-label" for="field_{{ field.id }}_{{ loop.index0 }}">{{ option|trim }}</label>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
        <hr>
    {% endfor %}

    <div>
        <label><strong>Location:</strong></label><br>
        <input type="text" name="location" class="form-control"
               value="{{ submitted_data.get('location', '') if submitted_data else '' }}">
    </div>

    <div style="margin-top: 10px;">
        <label><strong>Notes:</strong></label><br>
        <textarea name="notes" class="form-control" rows="3">{{ submitted_data.get('notes', '') if submitted_data else '' }}</textarea>
    </div>

    <div style="margin-top: 20px;">
        <button type="submit" class="btn btn-primary">Submit Inspection</button>
    </div>
</form>
{% endblock %}
